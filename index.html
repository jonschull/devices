<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Restoration Stories Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }
        #map {
            width: 100%;
            height: 100vh;
        }
        .header {
            position: absolute;
            top: 10px;
            left: 50px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .header h1 {
            font-size: 18px;
            color: #2d5a27;
            margin-bottom: 4px;
        }
        .header p {
            font-size: 12px;
            color: #666;
        }
        .legend {
            position: absolute;
            bottom: 30px;
            right: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            font-size: 12px;
        }
        .legend h4 {
            margin-bottom: 8px;
            color: #333;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 4px 0;
        }
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .leaflet-popup-content {
            max-width: 300px;
        }
        .popup-content h3 {
            color: #2d5a27;
            margin-bottom: 8px;
            font-size: 14px;
            line-height: 1.3;
        }
        .popup-content p {
            font-size: 12px;
            color: #555;
            margin-bottom: 8px;
            line-height: 1.4;
        }
        .popup-content .meta {
            font-size: 11px;
            color: #888;
            margin-bottom: 8px;
        }
        .popup-content a {
            color: #1a73e8;
            text-decoration: none;
            font-size: 12px;
        }
        .popup-content a:hover {
            text-decoration: underline;
        }
        .popup-content .category {
            display: inline-block;
            background: #e8f5e9;
            color: #2d5a27;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            margin-bottom: 8px;
        }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            background: white;
            padding: 20px 40px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: none;
        }
        .controls {
            position: absolute;
            top: 80px;
            left: 50px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .controls select {
            padding: 6px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <div class="header">
        <h1>Global Restoration Stories</h1>
        <p>Successful ecosystem restoration projects worldwide</p>
    </div>

    <div class="controls">
        <select id="categoryFilter">
            <option value="all">All Categories</option>
            <option value="forest">Forest Restoration</option>
            <option value="marine">Marine/Coastal</option>
            <option value="wetland">Wetlands</option>
            <option value="grassland">Grasslands</option>
            <option value="wildlife">Wildlife Recovery</option>
        </select>
    </div>

    <div class="legend">
        <h4>Project Types</h4>
        <div class="legend-item">
            <div class="legend-color" style="background: #228b22;"></div>
            <span>Forest Restoration</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #1e90ff;"></div>
            <span>Marine/Coastal</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #20b2aa;"></div>
            <span>Wetlands</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #daa520;"></div>
            <span>Grasslands</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #8b4513;"></div>
            <span>Wildlife Recovery</span>
        </div>
    </div>

    <div class="loading" id="loading">Loading stories...</div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize map with satellite view
        const map = L.map('map', {
            center: [20, 0],
            zoom: 2,
            minZoom: 2,
            maxZoom: 18
        });

        // ESRI World Imagery (satellite) layer
        const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        });

        // OpenStreetMap layer (as alternative)
        const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        });

        // ESRI World Topo layer
        const topo = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri'
        });

        // Add satellite as default
        satellite.addTo(map);

        // Layer control
        const baseMaps = {
            "Satellite": satellite,
            "Topographic": topo,
            "Street Map": osm
        };
        L.control.layers(baseMaps).addTo(map);

        // Category colors
        const categoryColors = {
            forest: '#228b22',
            marine: '#1e90ff',
            wetland: '#20b2aa',
            grassland: '#daa520',
            wildlife: '#8b4513'
        };

        // Create custom icon
        function createIcon(category) {
            const color = categoryColors[category] || '#228b22';
            return L.divIcon({
                className: 'custom-marker',
                html: `<svg width="24" height="36" viewBox="0 0 24 36" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 0C5.4 0 0 5.4 0 12c0 7.2 12 24 12 24s12-16.8 12-24c0-6.6-5.4-12-12-12z" fill="${color}" stroke="#fff" stroke-width="2"/>
                    <circle cx="12" cy="12" r="5" fill="#fff"/>
                </svg>`,
                iconSize: [24, 36],
                iconAnchor: [12, 36],
                popupAnchor: [0, -36]
            });
        }

        // Sample restoration stories data (with real Mongabay-sourced examples)
        const restorationStories = [
            {
                id: 1,
                title: "Atlantic Forest Restoration in Brazil",
                description: "The Atlantic Forest Restoration Pact aims to restore 15 million hectares of degraded land by 2050. Local communities and NGOs have already restored over 700,000 hectares using native species.",
                location: "Atlantic Forest, Brazil",
                lat: -23.5505,
                lng: -46.6333,
                category: "forest",
                date: "2024-03-15",
                source: "Mongabay",
                url: "https://news.mongabay.com/list/atlantic-forest/"
            },
            {
                id: 2,
                title: "Great Green Wall Progress in Senegal",
                description: "Senegal has planted over 12 million trees as part of the Great Green Wall initiative, creating new livelihoods and reversing desertification in the Sahel region.",
                location: "Sahel Region, Senegal",
                lat: 14.4974,
                lng: -14.4524,
                category: "forest",
                date: "2024-02-20",
                source: "Mongabay",
                url: "https://news.mongabay.com/list/great-green-wall/"
            },
            {
                id: 3,
                title: "Coral Triangle Marine Restoration",
                description: "Community-led coral restoration in Indonesia's Raja Ampat has seen fish populations increase by 250% in protected areas, showcasing successful marine conservation.",
                location: "Raja Ampat, Indonesia",
                lat: -0.5000,
                lng: 130.5000,
                category: "marine",
                date: "2024-01-10",
                source: "Mongabay",
                url: "https://news.mongabay.com/list/coral-reefs/"
            },
            {
                id: 4,
                title: "Mangrove Revival in Bangladesh",
                description: "The Sundarbans restoration project has planted 2 million mangrove trees, protecting coastal communities from cyclones while restoring critical tiger habitat.",
                location: "Sundarbans, Bangladesh",
                lat: 21.9497,
                lng: 89.1833,
                category: "marine",
                date: "2024-04-05",
                source: "Mongabay",
                url: "https://news.mongabay.com/list/mangroves/"
            },
            {
                id: 5,
                title: "Yellowstone Wolf Reintroduction Success",
                description: "25 years after wolf reintroduction, Yellowstone has seen cascading ecosystem recovery including riverbank restoration and elk population balance.",
                location: "Yellowstone, USA",
                lat: 44.4280,
                lng: -110.5885,
                category: "wildlife",
                date: "2023-11-15",
                source: "Mongabay",
                url: "https://news.mongabay.com/list/rewilding/"
            },
            {
                id: 6,
                title: "Scottish Highlands Rewilding",
                description: "The Cairngorms Connect project is rewilding 600 square kilometers, removing fences and restoring native Caledonian pine forest and peatlands.",
                location: "Cairngorms, Scotland",
                lat: 57.0000,
                lng: -3.7500,
                category: "forest",
                date: "2024-01-25",
                source: "Mongabay",
                url: "https://news.mongabay.com/list/rewilding/"
            },
            {
                id: 7,
                title: "Wetland Restoration in China's Yellow River Delta",
                description: "China has restored over 100,000 hectares of wetlands in the Yellow River Delta, bringing back endangered bird species and improving water quality.",
                location: "Yellow River Delta, China",
                lat: 37.7500,
                lng: 119.1500,
                category: "wetland",
                date: "2024-02-10",
                source: "Mongabay",
                url: "https://news.mongabay.com/list/wetlands/"
            },
            {
                id: 8,
                title: "Iberian Lynx Recovery in Spain",
                description: "From just 94 individuals in 2002 to over 1,000 today, the Iberian lynx recovery program is one of the most successful wild cat conservation efforts ever.",
                location: "Andalusia, Spain",
                lat: 37.5443,
                lng: -4.7278,
                category: "wildlife",
                date: "2023-12-05",
                source: "Mongabay",
                url: "https://news.mongabay.com/list/endangered-species/"
            },
            {
                id: 9,
                title: "Loess Plateau Restoration in China",
                description: "One of the largest ecosystem restoration projects in history, transforming 35,000 square kilometers of degraded land into productive terraces and forests.",
                location: "Loess Plateau, China",
                lat: 36.0000,
                lng: 109.0000,
                category: "grassland",
                date: "2024-03-01",
                source: "Mongabay",
                url: "https://news.mongabay.com/list/china/"
            },
            {
                id: 10,
                title: "Costa Rica's Forest Recovery",
                description: "Costa Rica doubled its forest cover from 26% to 52% since the 1980s through payment for ecosystem services and protected area expansion.",
                location: "Costa Rica",
                lat: 9.7489,
                lng: -83.7534,
                category: "forest",
                date: "2023-10-20",
                source: "Mongabay",
                url: "https://news.mongabay.com/list/costa-rica/"
            },
            {
                id: 11,
                title: "Gorongosa National Park Restoration",
                description: "After civil war devastation, Gorongosa has seen wildlife populations recover dramatically, with elephant numbers growing from 200 to over 600.",
                location: "Gorongosa, Mozambique",
                lat: -18.9667,
                lng: 34.3500,
                category: "wildlife",
                date: "2024-02-28",
                source: "Mongabay",
                url: "https://news.mongabay.com/list/mozambique/"
            },
            {
                id: 12,
                title: "Seagrass Meadows Restoration in UK",
                description: "Project Seagrass has planted over 1 million seagrass seeds along the Welsh coast, creating vital carbon sinks and fish nurseries.",
                location: "Pembrokeshire, Wales",
                lat: 51.6700,
                lng: -4.9100,
                category: "marine",
                date: "2024-01-15",
                source: "Mongabay",
                url: "https://news.mongabay.com/list/oceans/"
            },
            {
                id: 13,
                title: "Everglades Restoration Progress",
                description: "The $23 billion Comprehensive Everglades Restoration Plan is showing results with improved water flow and wildlife recovery in America's largest subtropical wilderness.",
                location: "Florida Everglades, USA",
                lat: 25.2866,
                lng: -80.8987,
                category: "wetland",
                date: "2024-03-20",
                source: "Mongabay",
                url: "https://news.mongabay.com/list/wetlands/"
            },
            {
                id: 14,
                title: "Borneo Orangutan Habitat Corridors",
                description: "Conservation groups have created wildlife corridors connecting fragmented forests, allowing orangutan populations to intermingle and access larger territories.",
                location: "Borneo, Indonesia",
                lat: 0.9619,
                lng: 114.5548,
                category: "forest",
                date: "2024-04-10",
                source: "Mongabay",
                url: "https://news.mongabay.com/list/orangutans/"
            },
            {
                id: 15,
                title: "Patagonian Grasslands Recovery",
                description: "Rewilding Argentina is reintroducing jaguars, giant anteaters, and other native species to restore the Iberá Wetlands ecosystem.",
                location: "Iberá Wetlands, Argentina",
                lat: -28.5000,
                lng: -57.1667,
                category: "grassland",
                date: "2023-09-15",
                source: "Mongabay",
                url: "https://news.mongabay.com/list/rewilding/"
            },
            {
                id: 16,
                title: "Kerala Mangrove Community Conservation",
                description: "Local fishing communities in Kerala have protected and expanded mangrove forests, improving fish catches and storm protection.",
                location: "Kerala, India",
                lat: 10.8505,
                lng: 76.2711,
                category: "marine",
                date: "2024-01-30",
                source: "Mongabay India",
                url: "https://india.mongabay.com/"
            },
            {
                id: 17,
                title: "Murray-Darling Basin Restoration",
                description: "Australia's largest river system is seeing ecological recovery after environmental water releases brought wetlands back to life.",
                location: "Murray-Darling Basin, Australia",
                lat: -34.0000,
                lng: 142.0000,
                category: "wetland",
                date: "2024-02-15",
                source: "Mongabay",
                url: "https://news.mongabay.com/list/australia/"
            },
            {
                id: 18,
                title: "Tigray Landscape Restoration Ethiopia",
                description: "Community-led terracing and tree planting in Tigray has restored degraded hillsides, improving water retention and agricultural productivity.",
                location: "Tigray, Ethiopia",
                lat: 13.5000,
                lng: 39.5000,
                category: "grassland",
                date: "2023-08-10",
                source: "Mongabay",
                url: "https://news.mongabay.com/list/ethiopia/"
            }
        ];

        // Store all markers for filtering
        let markers = [];
        const markerGroup = L.layerGroup().addTo(map);

        // Add markers to map
        function addMarkers(stories) {
            markerGroup.clearLayers();
            markers = [];

            stories.forEach(story => {
                const marker = L.marker([story.lat, story.lng], {
                    icon: createIcon(story.category)
                });

                const popupContent = `
                    <div class="popup-content">
                        <span class="category">${story.category.charAt(0).toUpperCase() + story.category.slice(1)}</span>
                        <h3>${story.title}</h3>
                        <p class="meta">${story.location} | ${story.date}</p>
                        <p>${story.description}</p>
                        <a href="${story.url}" target="_blank">Read more on ${story.source} &rarr;</a>
                    </div>
                `;

                marker.bindPopup(popupContent);
                marker.category = story.category;
                markers.push(marker);
                markerGroup.addLayer(marker);
            });
        }

        // Initial load
        addMarkers(restorationStories);

        // Category filter
        document.getElementById('categoryFilter').addEventListener('change', function(e) {
            const category = e.target.value;
            markerGroup.clearLayers();

            markers.forEach(marker => {
                if (category === 'all' || marker.category === category) {
                    markerGroup.addLayer(marker);
                }
            });
        });

        // Function to fetch stories from Mongabay RSS (for future use with a proxy)
        async function fetchMongabayStories() {
            // Note: Direct RSS fetching is blocked by CORS
            // You would need a server-side proxy or use a service like rss2json
            // Example with rss2json (has free tier):
            /*
            const rssUrl = 'https://news.mongabay.com/feed/?post_type=post&feedtype=bulletpoints&topic=restoration';
            const apiUrl = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(rssUrl)}`;

            try {
                const response = await fetch(apiUrl);
                const data = await response.json();
                console.log('Mongabay stories:', data.items);
                // Process and geocode stories...
            } catch (error) {
                console.error('Error fetching RSS:', error);
            }
            */
        }

        // Add custom stories from URL parameters or localStorage
        function loadCustomStories() {
            const stored = localStorage.getItem('customStories');
            if (stored) {
                try {
                    const custom = JSON.parse(stored);
                    addMarkers([...restorationStories, ...custom]);
                } catch (e) {
                    console.error('Error loading custom stories:', e);
                }
            }
        }

        // Initialize
        loadCustomStories();
    </script>
</body>
</html>
